<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>K-NET • Réseau Neon</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* === CONFIG === */
const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser=null, currentNick=null, currentRole=null, currentRoom='Global';

/* === AUTH === */
window.login = async () => {
  try{
    const cred = await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
    currentUser = cred.user;
  }catch(e){ alert(e.message); }
};

window.register = async () => {
  if(!regEmail.value||!regPass.value||!regNick.value||!regRole.value)
    return alert("Tous les champs sont requis");

  const cred = await createUserWithEmailAndPassword(auth, regEmail.value, regPass.value);
  await set(ref(db,'users/'+cred.user.uid),{
    nick: regNick.value,
    role: regRole.value
  });
};

window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};

onAuthStateChanged(auth, async user=>{
  if(!user) return;
  currentUser = user;
  const snap = await get(ref(db,'users/'+user.uid));
  if(!snap.exists()) return alert("Profil introuvable");

  currentNick = snap.val().nick;
  currentRole = snap.val().role;

  enterApp();
});

/* === APP === */
function enterApp(){
  landing.style.display='none';
  windows.style.display='none';
  appUI.style.display='flex';
  loadRooms();
}

function loadRooms(){
  roomSelect.innerHTML='';
  ['Global', currentRole].forEach(r=>{
    const o=document.createElement('option');
    o.value=o.textContent=r;
    roomSelect.appendChild(o);
  });
  roomSelect.onchange=()=>{currentRoom=roomSelect.value;loadMessages();};
  loadMessages();
}

window.sendMessage = ()=>{
  if(!chatText.value.trim())return;
  push(ref(db,'messages/'+currentRoom),{
    nick:currentNick,
    role:currentRole,
    uid:currentUser.uid,
    text:chatText.value,
    time:serverTimestamp()
  });
  chatText.value='';
};

function loadMessages(){
  const r = ref(db,'messages/'+currentRoom);
  onValue(r,snap=>{
    messages.innerHTML='';
    snap.forEach(c=>{
      const m=c.val();
      const d=document.createElement('div');
      d.className='message'+(m.uid===currentUser.uid?' me':'');
      d.innerHTML=`<b>${m.nick}</b> <span>${m.role}</span><br>${m.text}`;
      messages.appendChild(d);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}
</script>

<style>
:root{
  --bg:#01031a;
  --panel:#040a25;
  --neon:#2a6bff;
  --text:#e6ecff;
}
*{margin:0;box-sizing:border-box;font-family:Segoe UI,Arial}
body{
  height:100vh;
  background:radial-gradient(circle at center,#040a25,#01031a);
  color:var(--text);
  overflow:hidden;
}

/* === LANDING === */
#landing{
  position:fixed;inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}
.energy{
  position:absolute;
  width:900px;height:900px;
  background:conic-gradient(var(--neon),transparent 70%);
  filter:blur(100px);
  animation:spin 14s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.sphere{
  width:280px;height:280px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(circle at 30% 30%,#1a3cff,#020617);
  box-shadow:0 0 160px var(--neon);
  animation:pulse 4s infinite;
}
@keyframes pulse{50%{box-shadow:0 0 200px #5fa0ff}}

.logo{
  font-size:2.2rem;
  font-weight:900;
  letter-spacing:.3em;
}

/* === AUTH === */
#windows{
  display:none;
  position:fixed;inset:0;
  backdrop-filter:blur(16px);
  align-items:center;
  justify-content:center;
}
.window{
  width:360px;
  padding:32px;
  background:#020617;
  border-radius:24px;
  box-shadow:0 0 80px rgba(0,0,0,.8);
}
input,select,textarea{
  width:100%;
  margin-top:12px;
  padding:14px;
  border-radius:14px;
  background:#01031a;
  border:1px solid #0b1a55;
  color:white;
}
button{
  width:100%;
  margin-top:14px;
  padding:14px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#5fa0ff,#2a6bff);
  font-weight:900;
  cursor:pointer;
}

/* === APP === */
#appUI{
  display:none;
  height:100vh;
}
.sidebar{
  width:240px;
  background:#020617;
  padding:20px;
}
.content{
  flex:1;
  padding:24px;
  display:flex;
}
.chat{
  display:flex;
  flex-direction:column;
  width:100%;
}
.messages{
  flex:1;
  overflow-y:auto;
  margin:16px 0;
}
.message{
  background:#0b1a55;
  padding:12px 16px;
  border-radius:16px;
  margin-bottom:10px;
  max-width:75%;
}
.message.me{
  background:#2a6bff;
  color:#020617;
  margin-left:auto;
}
</style>

<body>

<div id="landing" onclick="landing.style.display='none';windows.style.display='flex'">
  <div class="energy"></div>
  <div class="sphere"><div class="logo">K-NET</div></div>
  <p style="margin-top:30px;opacity:.7">CLICK TO CONNECT</p>
</div>

<div id="windows">
  <div class="window">
    <h3>Connexion</h3>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password">
    <button onclick="login()">Entrer</button>

    <hr style="margin:20px 0">

    <h3>Inscription</h3>
    <input id="regEmail" placeholder="Email">
    <input id="regPass" type="password">
    <input id="regNick" placeholder="Pseudo">
    <select id="regRole">
      <option value="">Rôle</option>
      <option>Chauffeur</option>
      <option>Logisticien</option>
      <option>Organisateur</option>
      <option>Mécanicien</option>
    </select>
    <button onclick="register()">Créer le compte</button>
  </div>
</div>

<div id="appUI">
  <div class="sidebar">
    <b>K-NET</b><br><br>
    <button onclick="logout()">Déconnexion</button>
  </div>
  <div class="content">
    <div class="chat">
      <select id="roomSelect"></select>
      <div class="messages" id="messages"></div>
      <textarea id="chatText"></textarea>
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </div>
</div>

</body>
</html>
