<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Network Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Arial}
body{background:#0b0f1a;color:#fff;display:flex;height:100vh;overflow:hidden}

/* ===== SIDEBAR ===== */
.sidebar{
  width:80px;
  background:#0f172a;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px 0;
  gap:25px;
  transition:.4s;
}
.sidebar:hover{width:220px}
.logo{
  width:45px;height:45px;
  border-radius:50%;
  background:radial-gradient(circle,#38bdf8,#1e3a8a);
  position:relative;
}
.logo:before,.logo:after{
  content:"";
  position:absolute;
  width:8px;height:8px;
  background:#fff;border-radius:50%;
}
.logo:before{top:5px;left:18px}
.logo:after{bottom:5px;right:18px}

.sidebar button{
  width:180px;
  background:none;
  border:none;
  color:#cbd5f5;
  padding:10px;
  text-align:left;
  border-radius:10px;
  cursor:pointer;
  transition:.3s;
}
.sidebar button:hover,
.sidebar button.active{
  background:#1e293b;
  color:#38bdf8;
}

/* ===== MAIN ===== */
main{flex:1;padding:30px;animation:fade .4s}
section{display:none;height:100%}
section.active{display:block}

@keyframes fade{from{opacity:0;transform:translateX(20px)}to{opacity:1}}

/* ===== AUTH ===== */
.auth-box{
  max-width:400px;
  margin:80px auto;
  background:#020617;
  padding:25px;
  border-radius:15px;
  box-shadow:0 0 30px #020617;
}
.auth-box h2{text-align:center;margin-bottom:20px}
.auth-box input,.auth-box select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:none;
}
.auth-box button{
  width:100%;
  padding:10px;
  background:#38bdf8;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

/* ===== CHAT ===== */
.chat-box{
  height:100%;
  display:flex;
  flex-direction:column;
}
.chat-header{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
}
#messages{
  flex:1;
  overflow-y:auto;
  background:#020617;
  padding:15px;
  border-radius:12px;
}
.message{
  margin-bottom:10px;
  padding:8px 12px;
  border-radius:10px;
  background:#1e293b;
  animation:fade .2s;
}
.message.me{background:#1d4ed8}
.chat-input{
  display:flex;
  margin-top:10px;
}
.chat-input input{
  flex:1;
  padding:10px;
  border-radius:8px 0 0 8px;
  border:none;
}
.chat-input button{
  padding:10px 20px;
  border:none;
  background:#38bdf8;
  border-radius:0 8px 8px 0;
}

/* ===== PROFILE ===== */
.profile input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:none;
}
</style>
</head>

<body>

<!-- ===== SIDEBAR ===== -->
<div class="sidebar">
  <div class="logo"></div>
  <button onclick="showTab('auth')" id="authBtn" class="active">Вход</button>
  <button onclick="showTab('chat')">Чат</button>
  <button onclick="showTab('profile')">Профиль</button>
  <button onclick="logout()">Выход</button>
</div>

<!-- ===== MAIN ===== -->
<main>
  <!-- AUTH -->
  <section id="auth" class="active">
    <div class="auth-box">
      <h2>Вход / Регистрация</h2>
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Пароль">
      <select id="role">
        <option value="">Выберите роль</option>
        <option>Chauffeur</option>
        <option>Logisticien</option>
        <option>Organisateur</option>
        <option>Mécanicien</option>
      </select>
      <button onclick="register()">Регистрация</button>
      <button onclick="login()">Вход</button>
    </div>
  </section>

  <!-- CHAT -->
  <section id="chat">
    <div class="chat-box">
      <div class="chat-header">
        <select id="roomSelect"></select>
        <span id="userRole"></span>
      </div>
      <div id="messages"></div>
      <div class="chat-input">
        <input id="text" placeholder="Сообщение...">
        <button onclick="sendMessage()">➤</button>
      </div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="profile" class="profile">
    <h2>Профиль</h2>
    <input id="name" placeholder="Имя">
    <input id="userRole" disabled>
  </section>
</main>

<script>
/* ===== FIREBASE ===== */
firebase.initializeApp({
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT.firebaseio.com",
  projectId: "PROJECT"
});

const auth = firebase.auth();
const db = firebase.database();

let currentUser,currentRole,currentRoom;

/* ===== UI ===== */
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".sidebar button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

/* ===== AUTH ===== */
function register(){
  if(!role.value) return alert("Выберите роль");
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(c=>{
    db.ref("users/"+c.user.uid).set({
      name:"User",
      role:role.value
    });
  }).catch(alert);
}

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value).catch(alert);
}

function logout(){
  auth.signOut();
  location.reload();
}

auth.onAuthStateChanged(u=>{
  if(!u) return;
  currentUser=u;

  db.ref("users/"+u.uid).once("value").then(s=>{
    currentRole=s.val().role;
    userRole.value=currentRole;
    name.value=s.val().name;
    loadRooms();
    showTab("chat");
    authBtn.style.display="none";
  });
});

/* ===== ROOMS ===== */
function loadRooms(){
  roomSelect.innerHTML="";
  addRoom("Global");
  if(currentRole==="Administrateur"){
    ["Chauffeur","Logisticien","Organisateur","Mécanicien"].forEach(addRoom);
  }else addRoom(currentRole);

  currentRoom=roomSelect.value;
  roomSelect.onchange=()=>{currentRoom=roomSelect.value;loadMessages();}
  loadMessages();
}

function addRoom(r){
  const o=document.createElement("option");
  o.value=o.textContent=r;
  roomSelect.appendChild(o);
}

/* ===== CHAT ===== */
function sendMessage(){
  if(!text.value.trim())return;
  db.ref("messages/"+currentRoom).push({
    uid:currentUser.uid,
    name:name.value,
    role:currentRole,
    text:text.value,
    time:new Date().toLocaleTimeString()
  });
  text.value="";
}

function loadMessages(){
  const ref=db.ref("messages/"+currentRoom);
  ref.off();
  ref.on("value",s=>{
    messages.innerHTML="";
    s.forEach(c=>{
      const m=c.val();
      const d=document.createElement("div");
      d.className="message"+(m.uid===currentUser.uid?" me":"");
      d.innerHTML=`<b>${m.name}</b> (${m.role})<br>${m.text}`;
      messages.appendChild(d);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}
</script>
</body>
</html>
