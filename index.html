<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>üêâ LogiSupport</title>

<link rel="icon" type="image/svg+xml"
  href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <rect width='100' height='100' fill='black'/>
  <text x='50%' y='62%' font-size='62' text-anchor='middle' fill='%23b300ff'>üêâ</text>
  </svg>">

<style>
/* ==== DARK FANTASY UI ==== */
:root{
  --bg:#050008; --panel:#0b0014;
  --accent:#b300ff; --accent2:#00ffd5;
  --blood:#ff003c; --text:#f5f5ff; --muted:#9a8fb3;
}

*{box-sizing:border-box}
body{
  margin:0; font-family:Segoe UI,Arial;
  background:radial-gradient(circle at top,#16001f,#050008 60%);
  color:var(--text);
}
header{padding:20px;text-align:center}
.logo{font-size:2.6rem;font-weight:900;color:var(--accent);
  text-shadow:0 0 12px rgba(179,0,255,.8)}
.logo span{color:var(--accent2)}

.box{
  background:linear-gradient(145deg,#0e001a,#05000d);
  border-radius:18px;padding:18px;margin:12px;
  box-shadow:0 0 18px rgba(179,0,255,.3)
}
input,textarea,select{
  width:100%;padding:12px;margin-top:8px;
  border-radius:12px;border:1px solid rgba(179,0,255,.3);
  background:#07000e;color:#fff;
}
button{
  width:100%;margin-top:10px;padding:12px;
  border-radius:14px;border:none;font-weight:700;
  background:linear-gradient(135deg,#b300ff,#00ffd5);
  color:#020005;cursor:pointer;
}
button:hover{opacity:.9}
.messages{height:300px;overflow-y:auto}
.message{
  background:#0c0016;border-radius:12px;padding:10px;margin-bottom:8px;
}
small{color:var(--muted)}
.delete{
  float:right;background:#ff003c;border:none;border-radius:8px;
  color:#fff;padding:2px 8px;cursor:pointer
}
.hidden{display:none}
nav{display:flex;gap:8px;justify-content:center}
nav button{background:#12001f;color:#fff}
nav button.active{background:#ff003c}
.status{font-size:.9rem;color:#00ffd5}
</style>
</head>

<body>
<header>
  <div class="logo">üêâ <span>Logi</span>Support</div>
</header>

<nav>
  <button onclick="showTab('chat')" class="active">–ß–∞—Ç</button>
  <button onclick="showTab('files')">–§–∞–π–ª—ã</button>
  <button onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
  <button onclick="showTab('admin')">–ê–¥–º–∏–Ω</button>
</nav>

<section id="chat" class="box">
  <select id="chatRoom"></select>
  <div class="messages" id="messages"></div>
  <textarea id="content" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</section>

<section id="files" class="box hidden">
  <input type="file" id="fileInput">
  <button onclick="uploadFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <div id="fileList"></div>
</section>

<section id="profile" class="box hidden">
  <input id="pName" placeholder="–ò–º—è">
  <input id="pRole" placeholder="–†–æ–ª—å" disabled>
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</section>

<section id="admin" class="box hidden">
  <select id="roleUser"></select>
  <select id="newRole">
    <option>Chauffeur</option>
    <option>Logisticien</option>
    <option>M√©canicien</option>
    <option>Organisateur</option>
    <option>Administrateur</option>
  </select>
  <button onclick="setRole()">–°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</button>
</section>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "PASTE",
  authDomain: "PASTE",
  databaseURL: "PASTE",
  projectId: "PASTE",
  storageBucket: "PASTE",
  messagingSenderId: "PASTE",
  appId: "PASTE"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const storage = firebase.storage();
const auth = firebase.auth();

let currentUser = null;
let currentRole = null;
let currentRoom = null;

/* ===== AUTH ===== */
auth.signInAnonymously();

auth.onAuthStateChanged(user=>{
  if(!user) return;
  currentUser = user;
  const ref = db.ref("users/"+user.uid);
  ref.once("value",snap=>{
    if(!snap.exists()){
      ref.set({name:"User",role:"Chauffeur",online:true});
    }
  });
  ref.on("value",snap=>{
    const d = snap.val();
    currentRole = d.role;
    document.getElementById("pName").value = d.name;
    document.getElementById("pRole").value = d.role;
    loadRooms();
    loadUsers();
  });
});

/* ===== TABS ===== */
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

/* ===== ROOMS ===== */
function loadRooms(){
  const sel = document.getElementById("chatRoom");
  sel.innerHTML = "";
  const rooms = ["–û–±—â–∏–π",currentRole];
  rooms.forEach(r=>{
    const o=document.createElement("option");
    o.value=r;o.textContent=r;sel.appendChild(o);
  });
  sel.onchange=()=>{currentRoom=sel.value;loadMessages()};
  currentRoom=rooms[0];
  loadMessages();
}

/* ===== MESSAGES ===== */
function sendMessage(){
  const content=document.getElementById("content").value.trim();
  if(!content) return;

  db.ref("messages/"+currentRoom).push({
    uid:currentUser.uid,
    name:document.getElementById("pName").value,
    role:currentRole,
    content,
    time:new Date().toLocaleString()
  });

  logAction("message",content);
  notify("–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
  document.getElementById("content").value="";
}

function loadMessages(){
  if(!currentRoom) return;
  const ref=db.ref("messages/"+currentRoom);
  ref.off();
  ref.on("value",snap=>{
    const box=document.getElementById("messages");
    box.innerHTML="";
    snap.forEach(c=>{
      const m=c.val();
      const div=document.createElement("div");
      div.className="message";
      div.innerHTML=`<strong>${m.name}</strong> (${m.role})<br>${m.content}
      <br><small>${m.time}</small>`;
      if(currentRole==="Administrateur"){
        const b=document.createElement("button");
        b.textContent="X";b.className="delete";
        b.onclick=()=>c.ref.remove();
        div.appendChild(b);
      }
      box.appendChild(div);
    });
  });
}

/* ===== FILES ===== */
function uploadFile(){
  const f=document.getElementById("fileInput").files[0];
  if(!f) return alert("–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª");
  const ref=storage.ref("files/"+Date.now()+"_"+f.name);
  ref.put(f).then(()=>{
    ref.getDownloadURL().then(url=>{
      db.ref("files").push({
        name:f.name,url,
        user:currentUser.uid,time:new Date().toLocaleString()
      });
      notify("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω");
    });
  });
}

db.ref("files").on("value",snap=>{
  const list=document.getElementById("fileList");
  list.innerHTML="";
  snap.forEach(c=>{
    const f=c.val();
    const d=document.createElement("div");
    d.className="message";
    d.innerHTML=`üìÑ <a href="${f.url}" target="_blank">${f.name}</a>
    <br><small>${f.time}</small>`;
    list.appendChild(d);
  });
});

/* ===== PROFILE ===== */
function saveProfile(){
  const name=document.getElementById("pName").value;
  db.ref("users/"+currentUser.uid+"/name").set(name);
  notify("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω");
}

/* ===== ADMIN ===== */
function loadUsers(){
  const sel=document.getElementById("roleUser");
  sel.innerHTML="";
  db.ref("users").once("value",snap=>{
    snap.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.key;
      o.textContent=c.val().name+" ("+c.val().role+")";
      sel.appendChild(o);
    });
  });
}

function setRole(){
  if(currentRole!=="Administrateur") return alert("–ù–µ—Ç –ø—Ä–∞–≤");
  const uid=document.getElementById("roleUser").value;
  const role=document.getElementById("newRole").value;
  db.ref("users/"+uid+"/role").set(role);
  logAction("role_change",role);
  notify("–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞");
}

/* ===== LOGS ===== */
function logAction(type,detail){
  db.ref("logs").push({
    uid:currentUser.uid,
    type,detail,time:new Date().toLocaleString()
  });
}

/* ===== NOTIFY ===== */
function notify(text){
  if(Notification.permission==="granted"){
    new Notification(text);
  }else if(Notification.permission!=="denied"){
    Notification.requestPermission();
  }
}

/* ===== ONLINE ===== */
window.addEventListener("beforeunload",()=>{
  if(currentUser) db.ref("users/"+currentUser.uid+"/online").set(false);
});
</script>

</body>
</html>
