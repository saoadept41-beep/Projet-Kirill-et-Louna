<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>K-NET ‚Ä¢ Neon Network</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- FAVICON -->
<link rel="icon" type="image/svg+xml"
href='data:image/svg+xml,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
<rect width="100" height="100" rx="20" fill="black"/>
<text x="50%" y="65%" text-anchor="middle"
font-size="70" fill="cyan" font-family="Arial" font-weight="900">K</text>
</svg>'>

<style>
:root{
  --bg:#05060a; --panel:#0b1020; --panel2:#0f1733; --border:#1e2a55;
  --text:#eaf0ff; --muted:#9aa4c7; --neon:#00f6ff; --neon2:#7c7cff;
}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial;background:radial-gradient(circle at top,#101b44,#05060a 70%);color:var(--text);display:flex;min-height:100vh;}
.sidebar{width:260px;background:linear-gradient(180deg,#05060a,#080c1a);border-right:1px solid var(--border);padding:24px;}
.logo{display:flex;align-items:center;gap:14px;margin-bottom:40px;}
.logo-circle{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.8rem;color:var(--neon);box-shadow:0 0 10px var(--neon),0 0 25px rgba(0,246,255,.7);border:1px solid var(--neon);animation:pulse 3s infinite;}
.logo span{font-size:1.3rem;letter-spacing:.25em;font-weight:900;color:var(--neon);}
@keyframes pulse{0%,100%{box-shadow:0 0 10px var(--neon)}50%{box-shadow:0 0 25px var(--neon)}}
.menu button{width:100%;padding:14px;margin-bottom:10px;border-radius:16px;border:1px solid transparent;background:transparent;color:var(--text);text-align:left;cursor:pointer;transition:.3s;}
.menu button:hover{border-color:var(--neon);box-shadow:0 0 10px rgba(0,246,255,.4);}
.menu button.active{background:linear-gradient(135deg,var(--neon2),var(--neon));color:#05060a;font-weight:900;}
.content{flex:1;padding:32px}
section{max-width:900px;background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid var(--border);border-radius:24px;padding:24px;animation:fade .4s ease;}
.hidden{display:none}
@keyframes fade{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}
input,textarea,select{width:100%;padding:14px;margin-top:14px;background:#05060a;border:1px solid var(--border);border-radius:16px;color:var(--text);}
button.main{margin-top:18px;padding:14px;width:100%;border:none;border-radius:18px;background:linear-gradient(135deg,var(--neon2),var(--neon));color:#05060a;font-weight:900;cursor:pointer;box-shadow:0 0 20px rgba(0,246,255,.6);}
.messages{height:320px;overflow-y:auto;background:#05060a;border-radius:18px;padding:14px;}
.message{background:var(--panel);padding:12px 16px;border-radius:16px;margin-bottom:12px;}
.message.me{background:#14205a;box-shadow:0 0 10px rgba(124,124,255,.5);}
.message small{display:block;color:var(--muted);font-size:.75rem;}
</style>
</head>

<body>
<div class="sidebar">
  <div class="logo">
    <div class="logo-circle">K</div>
    <span>K-NET</span>
  </div>
  <div class="menu">
    <button onclick="showTab('auth')" class="active">üîê Connexion</button>
    <button onclick="showTab('chat')">üí¨ Discussions</button>
    <button onclick="showTab('profile')">üë§ Profil</button>
    <button onclick="logout()">üö™ D√©connexion</button>
  </div>
</div>

<div class="content">
  <section id="auth">
    <input id="email" placeholder="Adresse e-mail">
    <input id="password" type="password" placeholder="Mot de passe">
    <select id="role">
      <option value="">Choisissez un r√¥le</option>
      <option>Chauffeur</option>
      <option>Logisticien</option>
      <option>Organisateur</option>
      <option>M√©canicien</option>
      <option>Administrateur</option>
    </select>
    <button class="main" onclick="login()">Se connecter</button>
    <button class="main" onclick="register()">Cr√©er un compte</button>
  </section>

  <section id="chat" class="hidden">
    <select id="roomSelect"></select>
    <div class="messages" id="messages"></div>
    <textarea id="text" placeholder="Votre message‚Ä¶"></textarea>
    <button class="main" onclick="sendMessage()">Envoyer</button>
  </section>

  <section id="profile" class="hidden">
    <input id="name" placeholder="Nom affich√©">
    <input id="userRole" disabled>
  </section>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, off, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  storageBucket: "projet-56900.appspot.com",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser = null;
let currentRole = null;
let currentRoom = null;

/* ===== UI ===== */
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

/* ===== AUTH ===== */
function register(){
  const email = document.getElementById("email");
  const password = document.getElementById("password");
  const role = document.getElementById("role");

  if(!email.value || !password.value || !role.value){
    alert("Veuillez remplir email, mot de passe et r√¥le");
    return;
  }

  createUserWithEmailAndPassword(auth, email.value, password.value)
  .then(userCredential=>{
    currentUser = userCredential.user;
    currentRole = role.value;
    set(ref(db, 'users/' + currentUser.uid), {
      name: "User",
      role: currentRole
    });
    alert("Inscription r√©ussie: " + email.value);
    showTab('chat');
    loadRooms();
  })
  .catch(error=>{
    alert(error.code + "\n" + error.message);
    console.error(error);
  });
}

function login(){
  const email = document.getElementById("email");
  const password = document.getElementById("password");

  signInWithEmailAndPassword(auth, email.value, password.value)
  .then(userCredential=>{
    currentUser = userCredential.user;
    get(ref(db, 'users/' + currentUser.uid)).then(snapshot=>{
      if(snapshot.exists()){
        currentRole = snapshot.val().role;
        document.getElementById("userRole").value = currentRole;
        document.getElementById("name").value = snapshot.val().name;
        loadRooms();
        showTab('chat');
      }
    });
  })
  .catch(error=>{
    alert(error.code + "\n" + error.message);
  });
}

function logout(){
  signOut(auth).then(()=>{
    currentUser = null;
    currentRole = null;
    currentRoom = null;
    showTab('auth');
  });
}

/* ===== ROOMS ===== */
function loadRooms(){
  const roomSelect = document.getElementById("roomSelect");
  roomSelect.innerHTML = "";
  addRoom("Global");
  if(currentRole === "Administrateur"){
    ["Chauffeur","Logisticien","Organisateur","M√©canicien"].forEach(addRoom);
  } else if(currentRole === "Utilisateur") {
    addRoom("Global");
  } else {
    addRoom(currentRole);
  }

  currentRoom = roomSelect.value;
  roomSelect.onchange = ()=>{ currentRoom = roomSelect.value; loadMessages(); }
  loadMessages();
}

function addRoom(room){
  const roomSelect = document.getElementById("roomSelect");
  const option = document.createElement("option");
  option.value = option.textContent = room;
  roomSelect.appendChild(option);
}

/* ===== CHAT ===== */
function sendMessage(){
  const text = document.getElementById("text");
  if(!text.value.trim()) return;
  push(ref(db, 'messages/' + currentRoom), {
    uid: currentUser.uid,
    name: document.getElementById("name").value,
    role: currentRole,
    text: text.value,
    time: new Date().toLocaleTimeString()
  });
  text.value = "";
}

function loadMessages(){
  const messagesEl = document.getElementById("messages");
  const messagesRef = ref(db, 'messages/' + currentRoom);
  off(messagesRef);
  onValue(messagesRef, snapshot=>{
    messagesEl.innerHTML = "";
    snapshot.forEach(child=>{
      const m = child.val();
      const div = document.createElement("div");
      div.className = "message" + (m.uid === currentUser.uid ? " me" : "");
      div.innerHTML = `<b>${m.name}</b> (${m.role})<br>${m.text}<small>${m.time}</small>`;
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

/* ===== Make functions global for HTML onclick ===== */
window.register = register;
window.login = login;
window.logout = logout;
window.sendMessage = sendMessage;
window.showTab = showTab;
</script>

</body>
</html>
