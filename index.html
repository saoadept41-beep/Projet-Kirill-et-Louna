<script>
/* ===== FIREBASE INIT ===== */
firebase.initializeApp({
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT.firebaseio.com",
  projectId: "PROJECT"
});

const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let currentRole = null;
let currentRoom = null;

/* ===== UI ===== */
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ===== REGISTRATION ===== */
function register(){
  const email = document.getElementById("email");
  const password = document.getElementById("password");
  const role = document.getElementById("role");

  if (!email.value || !password.value) {
    alert("Введите email и пароль");
    return;
  }

  if (password.value.length < 6) {
    alert("Пароль должен быть минимум 6 символов");
    return;
  }

  auth.createUserWithEmailAndPassword(email.value, password.value)
    .then(cred => {
      return db.ref("users/" + cred.user.uid).set({
        email: email.value,
        role: role.value || "User",
        name: "User"
      });
    })
    .then(() => {
      alert("Регистрация прошла успешно ✅");
      showTab("chat");
    })
    .catch(error => {
      alert(error.code + "\n" + error.message);
      console.error(error);
    });
}

/* ===== LOGIN ===== */
function login(){
  const email = document.getElementById("email");
  const password = document.getElementById("password");

  if (!email.value || !password.value) {
    alert("Введите email и пароль");
    return;
  }

  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(error => {
      alert(error.code + "\n" + error.message);
    });
}

/* ===== LOGOUT ===== */
function logout(){
  auth.signOut();
  location.reload();
}

/* ===== AUTH STATE ===== */
auth.onAuthStateChanged(user=>{
  if(!user) return;

  currentUser = user;

  db.ref("users/" + user.uid).once("value").then(snap=>{
    const data = snap.val();
    currentRole = data.role;

    document.getElementById("userRole").value = data.role;
    document.getElementById("name").value = data.name;

    loadRooms();
    showTab("chat");
  });
});

/* ===== ROOMS ===== */
function loadRooms(){
  const roomSelect = document.getElementById("roomSelect");
  roomSelect.innerHTML = "";

  addRoom("Global");

  if (currentRole === "Administrateur") {
    ["Chauffeur","Logisticien","Organisateur","Mécanicien"].forEach(addRoom);
  } else {
    addRoom(currentRole);
  }

  currentRoom = roomSelect.value;
  roomSelect.onchange = ()=>{
    currentRoom = roomSelect.value;
    loadMessages();
  };

  loadMessages();
}

function addRoom(room){
  const o = document.createElement("option");
  o.value = room;
  o.textContent = room;
  roomSelect.appendChild(o);
}

/* ===== CHAT ===== */
function sendMessage(){
  const text = document.getElementById("text");
  if(!text.value.trim()) return;

  db.ref("messages/" + currentRoom).push({
    uid: currentUser.uid,
    name: document.getElementById("name").value,
    role: currentRole,
    text: text.value,
    time: new Date().toLocaleTimeString()
  });

  text.value = "";
}

function loadMessages(){
  const messages = document.getElementById("messages");
  const ref = db.ref("messages/" + currentRoom);
  ref.off();

  ref.on("value",snap=>{
    messages.innerHTML = "";
    snap.forEach(c=>{
      const m = c.val();
      const d = document.createElement("div");
      d.className = "message" + (m.uid === currentUser.uid ? " me" : "");
      d.innerHTML = `<b>${m.name}</b> (${m.role})<br>${m.text}`;
      messages.appendChild(d);
    });
    messages.scrollTop = messages.scrollHeight;
  });
}
</script>
