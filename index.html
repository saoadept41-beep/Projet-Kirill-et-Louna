<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>K-NET ‚Ä¢ Neon Network</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const ADMIN_EMAIL = "kirillmirisnik@gamil.com";

const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  storageBucket: "projet-56900.appspot.com",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let user, role, nick, room = "Global";

/* ===== AUTH ===== */
window.register = async () => {
  const email = regEmail.value;
  const pass = regPass.value;
  const n = regNick.value;
  const r = regRole.value;

  if (!email || !pass || !n || !r) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë");

  if (r === "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä") return alert("–ê–¥–º–∏–Ω –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é");

  const cred = await createUserWithEmailAndPassword(auth, email, pass);
  await set(ref(db, "users/" + cred.user.uid), { nick: n, role: r });
  loginAuto(cred.user);
};

window.login = async () => {
  const cred = await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
  loginAuto(cred.user);
};

async function loginAuto(u) {
  user = u;
  const snap = await get(ref(db, "users/" + u.uid));
  nick = snap.val()?.nick || "Admin";
  role = (u.email === ADMIN_EMAIL) ? "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" : snap.val()?.role;
  showApp();
}

window.logout = () => signOut(auth).then(() => location.reload());

/* ===== UI ===== */
function showApp() {
  landing.style.display = windows.style.display = "none";
  app.style.display = "flex";
  loadRooms();
}

/* ===== ROOMS ===== */
function loadRooms() {
  roomSelect.innerHTML = "";
  const rooms = role === "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
    ? ["Global", "–í–æ–¥–∏—Ç–µ–ª—å", "–õ–æ–≥–∏—Å—Ç–∏–∫", "–ú–µ—Ö–∞–Ω–∏–∫", "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä", "Admins"]
    : ["Global", role];

  rooms.forEach(r => {
    const o = document.createElement("option");
    o.value = o.textContent = r;
    roomSelect.appendChild(o);
  });

  room = roomSelect.value;
  loadMessages();
}

roomSelect.onchange = () => {
  room = roomSelect.value;
  loadMessages();
};

/* ===== CHAT ===== */
window.sendMessage = () => {
  if (!chatText.value.trim()) return;
  push(ref(db, "messages/" + room), {
    uid: user.uid,
    nick,
    role,
    text: chatText.value,
    time: new Date().toLocaleTimeString()
  });
  chatText.value = "";
};

function loadMessages() {
  messages.innerHTML = "";
  onValue(ref(db, "messages/" + room), snap => {
    messages.innerHTML = "";
    snap.forEach(c => {
      const m = c.val();
      const d = document.createElement("div");
      d.className = "message";
      d.innerHTML = `
        <b>${m.nick}</b> <small>${m.role}</small><br>
        ${m.text}
        <div class="time">${m.time}</div>
        ${role === "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" ? `<span class="del" onclick="deleteMsg('${c.key}')">üóë</span>` : ""}
      `;
      messages.appendChild(d);
    });
  });
}

window.deleteMsg = (id) => {
  if (role !== "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä") return;
  remove(ref(db, "messages/" + room + "/" + id));
};
</script>

<style>
body{margin:0;font-family:Segoe UI;background:#05070f;color:#e6ecff}
#landing,#windows,#app{height:100vh;display:flex;align-items:center;justify-content:center}
#windows,#app{display:none}
.window{background:#0b1024;padding:25px;border-radius:20px;width:300px}
input,select,textarea,button{width:100%;margin-top:10px;padding:12px;border-radius:12px;border:none}
button{background:linear-gradient(135deg,#ff6aff,#2aa8ff);font-weight:900;cursor:pointer}
.sidebar{width:220px;background:#02040c;padding:20px}
.content{flex:1;padding:20px}
.messages{height:300px;overflow:auto;background:#02040c;padding:10px;border-radius:12px}
.message{background:#0f1740;padding:10px;border-radius:10px;margin-bottom:8px;position:relative}
.del{position:absolute;top:5px;right:8px;cursor:pointer}
.time{font-size:10px;opacity:.6}
</style>
</head>

<body>

<div id="landing" onclick="this.style.display='none';windows.style.display='flex'">
  <h1>K-NET</h1>
</div>

<div id="windows">
  <div class="window">
    <h3>–í—Ö–æ–¥</h3>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <hr>
    <input id="regEmail" placeholder="Email">
    <input id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
    <input id="regNick" placeholder="–ù–∏–∫">
    <select id="regRole">
      <option>–í–æ–¥–∏—Ç–µ–ª—å</option>
      <option>–õ–æ–≥–∏—Å—Ç–∏–∫</option>
      <option>–ú–µ—Ö–∞–Ω–∏–∫</option>
      <option>–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</option>
    </select>
    <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>
</div>

<div id="app">
  <div class="sidebar">
    <select id="roomSelect"></select>
    <button onclick="logout()">–í—ã—Ö–æ–¥</button>
  </div>
  <div class="content">
    <div class="messages" id="messages"></div>
    <textarea id="chatText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

</body>
</html>

