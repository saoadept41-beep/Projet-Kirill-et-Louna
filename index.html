<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>K-NET</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, off } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { 
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  GoogleAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ===== State ===== */
let currentUser = null;
let currentNick = "";
let currentRole = "";
let currentRoom = "Global";
let messagesRef = null;

/* ===== AUTH ===== */
window.register = async () => {
  const email = regEmail.value;
  const pass = regPass.value;
  const nick = regNick.value;
  const role = regRole.value;

  if(!email || !pass || !nick || !role){
    alert("Tous les champs sont obligatoires");
    return;
  }

  const cred = await createUserWithEmailAndPassword(auth,email,pass);
  currentUser = cred.user;

  await set(ref(db,"users/"+currentUser.uid),{
    nick,
    role
  });

  currentNick = nick;
  currentRole = role;
  showApp();
};

window.login = async () => {
  const email = loginEmail.value;
  const pass = loginPass.value;

  const cred = await signInWithEmailAndPassword(auth,email,pass);
  currentUser = cred.user;

  const snap = await get(ref(db,"users/"+currentUser.uid));
  currentNick = snap.val().nick;
  currentRole = snap.val().role;

  showApp();
};

window.googleLogin = async () => {
  const result = await signInWithPopup(auth,provider);
  currentUser = result.user;

  const uref = ref(db,"users/"+currentUser.uid);
  const snap = await get(uref);

  if(!snap.exists()){
    await set(uref,{
      nick: currentUser.displayName || "GoogleUser",
      role: "Chauffeur"
    });
    currentNick = currentUser.displayName || "GoogleUser";
    currentRole = "Chauffeur";
  } else {
    currentNick = snap.val().nick;
    currentRole = snap.val().role;
  }
  showApp();
};

window.logout = async () => {
  await signOut(auth);
  location.reload();
};

/* ===== UI ===== */
function showApp(){
  landing.style.display="none";
  windows.style.display="none";
  appDiv.style.display="flex";
  loadRooms();
}

/* ===== ROOMS ===== */
function loadRooms(){
  roomSelect.innerHTML="";
  addRoom("Global");

  if(currentRole === "Administrateur"){
    ["Chauffeur","Logisticien","Organisateur","Mécanicien","Admins"].forEach(addRoom);
  } else {
    addRoom(currentRole);
  }

  roomSelect.onchange = ()=>{
    currentRoom = roomSelect.value;
    loadMessages();
  };

  currentRoom = roomSelect.value;
  loadMessages();
}

function addRoom(r){
  const o = document.createElement("option");
  o.value=o.textContent=r;
  roomSelect.appendChild(o);
}

/* ===== MESSAGES ===== */
window.sendMessage = ()=>{
  if(!chatText.value.trim()) return;

  push(ref(db,"messages/"+currentRoom),{
    uid: currentUser.uid,
    nick: currentNick,
    role: currentRole,
    text: chatText.value,
    time: new Date().toLocaleTimeString()
  });
  chatText.value="";
};

function loadMessages(){
  if(messagesRef) off(messagesRef);
  messages.innerHTML="";

  messagesRef = ref(db,"messages/"+currentRoom);
  onValue(messagesRef,snap=>{
    messages.innerHTML="";
    snap.forEach(c=>{
      const m=c.val();
      const d=document.createElement("div");
      d.className="message"+(m.uid===currentUser.uid?" me":"");
      d.innerHTML=`<b>${m.nick}</b> (${m.role})<br>${m.text}<small>${m.time}</small>`;
      messages.appendChild(d);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}
</script>

<style>
body{margin:0;background:#05070f;color:#e6ecff;font-family:Segoe UI}
.hidden{display:none}
#app{display:none;height:100vh}
.sidebar{width:220px;background:#060a1d;padding:20px}
button{padding:12px;border-radius:12px;border:none;background:#7f8cff;color:#000;font-weight:700;cursor:pointer}
.content{flex:1;padding:20px}
.messages{height:320px;background:#02040c;border-radius:12px;padding:10px;overflow-y:auto}
.message{background:#0b1a3a;margin-bottom:8px;padding:8px;border-radius:10px}
.message.me{background:#1e2a66}
</style>
</head>

<body>

<div id="landing" onclick="this.style.display='none';windows.style.display='flex';" style="height:100vh;display:flex;align-items:center;justify-content:center;">
<h1>K-NET</h1>
</div>

<div id="windows" style="display:none;gap:20px;justify-content:center;">
  <div>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="googleLogin()">Google</button>
  </div>

  <div>
    <input id="regEmail" placeholder="Email">
    <input id="regPass" type="password">
    <input id="regNick" placeholder="Nick">
    <select id="regRole">
      <option value="">Rôle</option>
      <option>Chauffeur</option>
      <option>Logisticien</option>
      <option>Organisateur</option>
      <option>Mécanicien</option>
    </select>
    <button onclick="register()">Register</button>
  </div>
</div>

<div id="app" style="display:flex" id="appDiv">
  <div class="sidebar">
    <button onclick="logout()">Logout</button>
  </div>
  <div class="content">
    <select id="roomSelect"></select>
    <div class="messages" id="messages"></div>
    <textarea id="chatText"></textarea>
    <button onclick="sendMessage()">Envoyer</button>
  </div>
</div>

</body>
</html>
