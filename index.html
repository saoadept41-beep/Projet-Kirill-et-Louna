<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>K-NET ‚Ä¢ Neon Network</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Segoe UI,Arial;background:#05060a;color:#fff;display:flex;margin:0;min-height:100vh;}
.sidebar{width:260px;background:#0b1020;padding:24px;display:flex;flex-direction:column;}
.logo-circle{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:1.8rem;color:#00f6ff;border:1px solid #00f6ff;margin-bottom:20px;}
.menu button{margin-bottom:10px;padding:14px;border-radius:16px;border:none;background:#0b1020;color:#fff;text-align:left;cursor:pointer;}
.menu button.active{background:#00f6ff;color:#05060a;font-weight:900;}
.content{flex:1;padding:32px;}
section{max-width:900px;background:#0f1733;border-radius:24px;padding:24px;margin-bottom:20px;display:none;}
section.active{display:block;}
input,select,textarea{width:100%;padding:12px;margin-top:12px;background:#05060a;border:1px solid #1e2a55;border-radius:16px;color:#fff;}
button.main{margin-top:12px;padding:12px;width:100%;border:none;border-radius:18px;background:#00f6ff;color:#05060a;font-weight:900;cursor:pointer;}
.messages{height:300px;overflow-y:auto;background:#05060a;border-radius:18px;padding:14px;margin-top:12px;}
.message{background:#0b1020;padding:12px;border-radius:16px;margin-bottom:12px;}
.message.me{background:#14205a;box-shadow:0 0 10px rgba(124,124,255,.5);}
</style>
</head>

<body>
<div class="sidebar">
  <div class="logo-circle">K</div>
  <div class="menu">
    <button onclick="showTab('auth')" class="active" id="authBtn">üîê Connexion</button>
    <button onclick="showTab('chat')" id="chatBtn">üí¨ Discussions</button>
    <button onclick="showTab('profile')" id="profileBtn">üë§ Profil</button>
    <button onclick="logout()">üö™ D√©connexion</button>
  </div>
</div>

<div class="content">
  <section id="auth" class="active">
    <input id="email" placeholder="Adresse e-mail">
    <input id="password" type="password" placeholder="Mot de passe">
    <select id="role">
      <option value="">Choisissez un r√¥le</option>
      <option>Chauffeur</option>
      <option>Logisticien</option>
      <option>Organisateur</option>
      <option>M√©canicien</option>
      <option>Administrateur</option>
    </select>
    <button class="main" onclick="register()">Cr√©er un compte</button>
    <button class="main" onclick="login()">Se connecter</button>
  </section>

  <section id="chat">
    <select id="roomSelect"></select>
    <div class="messages" id="messages"></div>
    <textarea id="text" placeholder="Votre message‚Ä¶"></textarea>
    <button class="main" onclick="sendMessage()">Envoyer</button>
  </section>

  <section id="profile">
    <input id="name" placeholder="Nom affich√©">
    <input id="userRole" disabled>
    <button class="main" onclick="updateProfile()">Mettre √† jour le profil</button>
  </section>
</div>

<!-- Firebase SDK v9+ Modular -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  storageBucket: "projet-56900.appspot.com",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// ----- UI helpers -----
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const roleSelect = document.getElementById("role");
const nameInput = document.getElementById("name");
const userRoleInput = document.getElementById("userRole");
const roomSelect = document.getElementById("roomSelect");
const messagesDiv = document.getElementById("messages");
const textInput = document.getElementById("text");

let currentUser = null;
let currentRole = null;
let currentRoom = "Global";

// ----- Tabs -----
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// ----- Auth -----
function register(){
  if(!emailInput.value || !passwordInput.value || !roleSelect.value){
    alert("Remplissez tous les champs !");
    return;
  }
  createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value)
  .then(userCred=>{
    const user = userCred.user;
    set(ref(db,'users/'+user.uid),{
      email: emailInput.value,
      role: roleSelect.value,
      name: "User"
    });
    alert("Inscription r√©ussie !");
  })
  .catch(err=>{
    alert(err.code+"\n"+err.message);
  });
}

function login(){
  if(!emailInput.value || !passwordInput.value){
    alert("Remplissez tous les champs !");
    return;
  }
  signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value)
  .then(userCred=>{
    currentUser = userCred.user;
    loadUserData();
  })
  .catch(err=>{
    alert(err.code+"\n"+err.message);
  });
}

function logout(){
  signOut(auth);
  currentUser = null;
  location.reload();
}

// ----- Load user & chat -----
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    loadUserData();
  }
});

function loadUserData(){
  const userRef = ref(db,'users/'+currentUser.uid);
  onValue(userRef,snap=>{
    const data = snap.val();
    currentRole = data.role;
    nameInput.value = data.name;
    userRoleInput.value = currentRole;
    setupRooms();
    showTab('chat');
    document.getElementById('authBtn').style.display="none";
  });
}

// ----- Chat -----
function setupRooms(){
  roomSelect.innerHTML="";
  const rooms = ["Global"];
  if(currentRole==="Administrateur"){
    rooms.push("Admin");
    rooms.push("Avec Admin");
    ["Chauffeur","Logisticien","Organisateur","M√©canicien"].forEach(r=>rooms.push(r));
  }else{
    rooms.push(currentRole);
    rooms.push("Avec Admin");
  }
  rooms.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = opt.textContent = r;
    roomSelect.appendChild(opt);
  });
  currentRoom = roomSelect.value;
  roomSelect.onchange=()=>{currentRoom=roomSelect.value;loadMessages();}
  loadMessages();
}

function sendMessage(){
  if(!textInput.value.trim()) return;
  push(ref(db,'messages/'+currentRoom),{
    uid: currentUser.uid,
    name: nameInput.value,
    role: currentRole,
    text: textInput.value,
    time: new Date().toLocaleTimeString()
  });
  textInput.value="";
}

function loadMessages(){
  const refMsg = ref(db,'messages/'+currentRoom);
  messagesDiv.innerHTML="";
  onValue(refMsg,snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(c=>{
      const m = c.val();
      const div = document.createElement("div");
      div.className="message"+(m.uid===currentUser.uid?" me":"");
      div.innerHTML=`<b>${m.name}</b> (${m.role})<br>${m.text}<small>${m.time}</small>`;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// ----- Profile -----
function updateProfile(){
  const newName = nameInput.value;
  set(ref(db,'users/'+currentUser.uid+'/name'), newName);
  alert("Profil mis √† jour !");
}

</script>
</body>
</html>
