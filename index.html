<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>LogiSupport • Профессиональная платформа</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='black'/><text x='50%' y='60%' text-anchor='middle' font-size='60' fill='white'>LS</text></svg>">

<style>
:root{
 --bg:#0a0d14;--panel:#141926;--panel2:#1b2233;--border:#2a3142;
 --text:#eef1f7;--muted:#9aa3af;--accent:#6da7ff;--danger:#ff6b6b;
}
*{box-sizing:border-box;}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:radial-gradient(circle at top,#1b2238,#0a0d14 70%);color:var(--text);}
header{display:flex;align-items:center;justify-content:center;gap:14px;padding:18px;border-bottom:1px solid var(--border);}
.logo{width:48px;height:48px;border-radius:14px;background:linear-gradient(135deg,#6da7ff,#9fbfff);display:flex;align-items:center;justify-content:center;color:#000;font-weight:900;font-size:1.5rem;}
nav{display:flex;gap:8px;justify-content:center;padding:10px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
nav button{background:var(--panel);color:var(--text);border:1px solid var(--border);padding:8px 16px;border-radius:12px;cursor:pointer;transition:.2s;}
nav button.active{background:var(--panel2);border-color:var(--accent);}
nav button:hover{background:var(--panel2);}
main{max-width:1100px;margin:auto;padding:20px;}
.box{padding:20px;background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid var(--border);border-radius:18px;box-shadow:0 15px 40px rgba(0,0,0,.45);margin-bottom:20px;}
.hidden{display:none;}
input,textarea,select{width:100%;padding:12px;margin-top:10px;background:#0a0d14;color:var(--text);border:1px solid var(--border);border-radius:12px;}
button.main{margin-top:12px;width:100%;padding:12px;border:none;border-radius:12px;font-weight:800;background:linear-gradient(135deg,#6da7ff,#9fbfff);color:#000;cursor:pointer;}
.chat-layout{display:grid;grid-template-columns:220px 1fr;gap:12px;}
.rooms{background:#0a0d14;border:1px solid var(--border);border-radius:14px;padding:10px;}
.rooms button{width:100%;margin-bottom:6px;}
.messages{height:360px;overflow-y:auto;padding:10px;background:#0a0d14;border-radius:14px;border:1px solid var(--border);}
.message{display:flex;align-items:flex-start;gap:10px;padding:10px;margin-bottom:8px;background:var(--panel);border-radius:14px;position:relative;}
.message.me{background:#222b40;justify-content:flex-end;}
.message img{width:36px;height:36px;border-radius:50%;}
.message-content{flex:1;}
.message-content b{display:block;}
.message-content small{display:block;font-size:.7rem;color:var(--muted);margin-top:4px;}
.delete{background:var(--danger);border:none;border-radius:6px;color:#fff;padding:2px 6px;cursor:pointer;margin-left:6px;}
.badge{display:inline-block;background:#2ecc71;color:#000;padding:2px 6px;border-radius:6px;font-size:.7rem;margin-left:6px;}
.admin-card{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px;}
.stat{background:#0a0d14;border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center;}
footer{text-align:center;padding:30px;color:var(--muted);}
</style>
</head>
<body>

<header>
 <div class="logo">LS</div>
 <h1>LogiSupport</h1>
</header>

<nav>
 <button id="tabAuth" class="active" onclick="showTab('auth')">Вход</button>
 <button id="tabChat" onclick="showTab('chat')">Чаты</button>
 <button id="tabProfile" onclick="showTab('profile')">Профиль</button>
 <button id="tabAdmin" class="hidden" onclick="showTab('admin')">Админ</button>
</nav>

<main>
<!-- Авторизация -->
<section id="auth" class="box">
 <input id="email" placeholder="Email">
 <input id="password" type="password" placeholder="Пароль">
 <select id="roleRegister">
  <option value="">Выберите роль</option>
  <option>Chauffeur</option>
  <option>Logisticien</option>
  <option>Organisateur</option>
  <option>Mécanicien</option>
 </select>
 <button class="main" onclick="login()">Войти</button>
 <button class="main" onclick="register()">Регистрация</button>
</section>

<!-- Чат -->
<section id="chat" class="box hidden">
 <div class="chat-layout">
  <div class="rooms" id="rooms"></div>
  <div>
   <div class="messages" id="messages"></div>
   <textarea id="content" placeholder="Сообщение"></textarea>
   <button class="main" onclick="sendMessage()">Отправить</button>
  </div>
 </div>
</section>

<!-- Профиль -->
<section id="profile" class="box hidden">
 <input id="pName" placeholder="Имя">
 <input id="pRole" disabled>
 <input type="file" id="avatar">
 <button class="main" onclick="saveProfile()">Сохранить</button>
</section>

<!-- Админ -->
<section id="admin" class="box hidden">
 <div class="admin-card">
  <div class="stat"><h3 id="statUsers">0</h3><p>Пользователи</p></div>
  <div class="stat"><h3 id="statMessages">0</h3><p>Сообщения</p></div>
  <div class="stat"><h3>Онлайн</h3><p id="statOnline">0</p></div>
 </div>
 <h3>Audit Log</h3>
 <div class="messages" id="audit"></div>
</section>
</main>

<footer>LogiSupport • Профессиональная платформа • Firebase</footer>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, off } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser,currentRole,currentRoom;
const ROOMS=["Global","Chauffeur","Logisticien","Organisateur","Mécanicien"];

// Tabs
function showTab(id){
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)).classList.add('active');
}

// Auth
function login(){ signInWithEmailAndPassword(auth,email.value,password.value).catch(alert); }
function register(){
  if(!roleRegister.value) return alert("Выберите роль");
  createUserWithEmailAndPassword(auth,email.value,password.value).then(res=>{
    set(ref(db,'users/'+res.user.uid),{name:'User',role:roleRegister.value,avatar:''});
  }).catch(alert);
}

onAuthStateChanged(auth,user=>{
  if(!user) return;
  currentUser=user;
  onValue(ref(db,'users/'+user.uid),s=>{
    const d=s.val();
    currentRole=d.role;
    pName.value=d.name;
    pRole.value=d.role;
    tabAdmin.classList.toggle('hidden',d.role!=="Administrateur");
    loadRooms();
    loadStats();
  });
  showTab('chat');
});

// Rooms
function loadRooms(){
  rooms.innerHTML='';
  ROOMS.forEach(r=>{
    if(r==='Global'||r===currentRole||currentRole==='Administrateur'){
      const b=document.createElement('button'); b.textContent=r;
      b.onclick=()=>{ currentRoom=r; loadMessages(); };
      rooms.appendChild(b);
    }
  });
  currentRoom=currentRoom||'Global';
  loadMessages();
}

// Messages
function sendMessage(){
  if(!content.value.trim()) return;
  push(ref(db,'messages/'+currentRoom),{
    uid:currentUser.uid,
    name:pName.value,
    role:currentRole,
    text:content.value,
    time:new Date().toLocaleString(),
    resolved:false
  });
  content.value='';
}

function loadMessages(){
  const refRoom = ref(db,'messages/'+currentRoom);
  off(refRoom);
  onValue(refRoom,snap=>{
    messages.innerHTML='';
    snap.forEach(c=>{
      const m=c.val();
      const div=document.createElement('div');
      div.className='message'+(m.uid===currentUser.uid?' me':'');
      div.innerHTML=`<img src="${m.avatar||''}" onerror="this.style.display='none'"><div class="message-content"><b>${m.name}</b>${m.text}<small>${m.time}</small>${m.resolved?'<span class="badge">résolu</span>':''}</div>`;
      if(m.uid===currentUser.uid||currentRole==='Administrateur'){
        const del=document.createElement('button'); del.textContent='×'; del.className='delete';
        del.onclick=()=>push(ref(db,'messages/'+currentRoom+'/'+c.key).remove);
        div.appendChild(del);
      }
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

// Profile
function saveProfile(){
  set(ref(db,'users/'+currentUser.uid+'/name'),pName.value);
  const file = avatar.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e => set(ref(db,'users/'+currentUser.uid+'/avatar'), e.target.result);
    reader.readAsDataURL(file);
  }
}

// Admin stats
function loadStats(){
  onValue(ref(db,'users'),snap=>statUsers.textContent=snap.numChildren());
  onValue(ref(db,'messages'),snap=>{
    let c=0;
    snap.forEach(r=>c+=r.numChildren());
    statMessages.textContent=c;
  });
}
</script>
</body>
</html>
