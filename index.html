<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>K-NET • Réseau Neon</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, off, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  storageBucket: "projet-56900.firebasestorage.app",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser=null,currentRole=null,currentNick=null,currentRoom='Global';

window.register=async()=>{
  const email=regEmail.value,pass=regPass.value,nick=regNick.value,role=regRole.value;
  if(!email||!pass||!nick||!role)return alert('Remplissez tous les champs');
  const cred=await createUserWithEmailAndPassword(auth,email,pass);
  currentUser=cred.user;
  await set(ref(db,'users/'+currentUser.uid),{nick,role});
};

window.login=async()=>{
  const cred=await signInWithEmailAndPassword(auth,loginEmail.value,loginPass.value);
  currentUser=cred.user;
  const snap=await get(ref(db,'users/'+currentUser.uid));
  currentNick=snap.val().nick;
  currentRole=snap.val().role;
  showApp();
};

window.logout=async()=>{await signOut(auth);location.reload();};

function showApp(){
  landing.style.display='none';
  windows.style.display='none';
  appUI.style.display='flex';
  userName.value=currentNick;
  userRole.value=currentRole;
  loadRooms();
}

function loadRooms(){
  roomSelect.innerHTML='';
  ['Global',currentRole].filter((v,i,a)=>a.indexOf(v)===i).forEach(r=>{
    const o=document.createElement('option');
    o.value=o.textContent=r;
    roomSelect.appendChild(o);
  });
  roomSelect.onchange=()=>{currentRoom=roomSelect.value;loadMessages();};
  loadMessages();
}

window.sendMessage=()=>{
  if(!chatText.value.trim())return;
  push(ref(db,'messages/'+currentRoom),{
    uid:currentUser.uid,
    nick:currentNick,
    role:currentRole,
    text:chatText.value,
    time:serverTimestamp()
  });
  chatText.value='';
  chatText.style.height='56px';
};

function loadMessages(){
  const messagesRef=ref(db,'messages/'+currentRoom);
  onValue(messagesRef,snap=>{
    messages.innerHTML='';
    snap.forEach(c=>{
      const m=c.val();
      const d=document.createElement('div');
      d.className='message'+(m.uid===currentUser.uid?' me':'');
      d.innerHTML=`<b>${m.nick}</b><span class="role">${m.role}</span><br>${m.text}`;
      messages.appendChild(d);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

chatText.addEventListener('input',()=>{
  chatText.style.height='auto';
  chatText.style.height=chatText.scrollHeight+'px';
});
</script>

<style>
:root{--bg:#01031a;--panel:#05113c;--border:#0b1a55;--text:#e6ecff;--neon:#2a6bff;}
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{
  margin:0;
  background:radial-gradient(circle,var(--panel),var(--bg));
  color:var(--text);
  height:100vh;
}

/* AUTH */
#windows,#landing{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
.window{width:360px;padding:32px;border-radius:24px;background:#020617}

/* APP */
#appUI{
  display:none;
  height:100vh;
}

.sidebar{
  width:240px;
  padding:20px;
  background:#020617;
  border-right:1px solid var(--border);
}

.content{
  flex:1;
  height:100vh;
  overflow:hidden;
  padding:24px;
}

.chat-layout{
  display:flex;
  flex-direction:column;
  height:100%;
  gap:14px;
}

.chat-header{
  position:sticky;
  top:0;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:14px;
  border-radius:18px;
  background:#020617;
}

.message{
  max-width:80%;
  padding:12px 16px;
  margin-bottom:12px;
  border-radius:16px;
  background:#0b1a55;
}

.message.me{
  margin-left:auto;
  background:var(--neon);
  color:#020617;
}

.chat-input{
  display:flex;
  gap:12px;
}

textarea{
  flex:1;
  resize:none;
  height:56px;
  border-radius:14px;
  padding:14px;
}

button{
  width:140px;
  border-radius:14px;
  background:var(--neon);
  border:none;
  font-weight:700;
}
.role{
  font-size:.7rem;
  opacity:.6;
  margin-left:6px;
}
</style>

<body>

<div id="windows">
  <div class="window">
    <h3>Connexion</h3>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password" placeholder="Mot de passe">
    <button onclick="login()">Entrer</button>
  </div>
</div>

<div id="appUI">
  <div class="sidebar">
    <b>K-NET</b><br><br>
    <button onclick="logout()">Déconnexion</button>
  </div>

  <div class="content">
    <section class="chat-layout">
      <div class="chat-header">
        <select id="roomSelect"></select>
      </div>

      <div class="messages" id="messages"></div>

      <div class="chat-input">
        <textarea id="chatText" placeholder="Message..."></textarea>
        <button onclick="sendMessage()">Envoyer</button>
      </div>
    </section>
  </div>
</div>

</body>
</html>

