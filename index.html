<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>K-NET ‚Ä¢ God Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ===== –í–°–¢–ê–í–¨ –°–í–û–ô FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBLbswX9MiSInVqNW12POJ5OmAYKgy2ERw",
  authDomain: "projet-56900.firebaseapp.com",
  databaseURL: "https://projet-56900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "projet-56900",
  storageBucket: "projet-56900.firebasestorage.app",
  messagingSenderId: "753669702381",
  appId: "1:753669702381:web:0ac180682fba00c68542e4",
  measurementId: "G-M9X20GDLQN"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser=null,currentRole=null,currentNick=null,currentRoom='Global',unsubscribeMessages=null;

/* ===== REGISTER ===== */
window.register = async () => {
  const email = regEmail.value, pass = regPass.value, nick = regNick.value, role = regRole.value;
  if(!email || !pass || !nick || !role){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return;}
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    currentUser = cred.user; currentNick = nick; currentRole = role;
    await set(ref(db,'users/'+currentUser.uid),{nick,role});
    showWelcome();
  }catch(e){alert(e.message);}
};

/* ===== LOGIN ===== */
window.login = async () => {
  try{
    const cred = await signInWithEmailAndPassword(auth,loginEmail.value,loginPass.value);
    currentUser = cred.user;
    const snap = await ref(db,'users/'+currentUser.uid).get();
    const data = (await snap.get()).val();
    currentNick = data.nick; currentRole = data.role;
    showSystem();
  }catch(e){alert(e.message);}
};

/* ===== LOGOUT ===== */
window.logout = async () => { await signOut(auth); location.reload(); };

/* ===== SHOW WELCOME ===== */
function showWelcome(){
  authScreen.style.display='none';
  welcomeScreen.style.display='flex';
}

/* ===== SHOW SYSTEM ===== */
function showSystem(){
  authScreen.style.display='none';
  welcomeScreen.style.display='none';
  systemScreen.style.display='flex';
  loadRooms();
}

/* ===== ROOMS ===== */
function loadRooms(){
  roomSelect.innerHTML='';
  addRoom('Global');
  if(currentRole==='Administrateur') ['Chauffeur','Logisticien','Organisateur','M√©canicien'].forEach(addRoom);
  else addRoom(currentRole);
  roomSelect.onchange=()=>{currentRoom=roomSelect.value; loadMessages();};
  currentRoom = roomSelect.value;
  loadMessages();
}
function addRoom(name){const o=document.createElement('option'); o.value=o.textContent=name; roomSelect.appendChild(o);}

/* ===== CHAT ===== */
window.sendMessage = () => {
  if(!chatText.value.trim()) return;
  push(ref(db,'messages/'+currentRoom),{
    uid:currentUser.uid,
    nick:currentNick,
    role:currentRole,
    text:chatText.value,
    time:new Date().toLocaleTimeString()
  });
  chatText.value='';
};
function loadMessages(){
  if(unsubscribeMessages) off(unsubscribeMessages);
  messages.innerHTML='';
  const messagesRef = ref(db,'messages/'+currentRoom);
  onValue(messagesRef,snap=>{
    messages.innerHTML='';
    snap.forEach(c=>{
      const m = c.val();
      const d = document.createElement('div');
      d.className='message'+(m.uid===currentUser.uid?' me':'');
      d.innerHTML=`<b>${m.nick}</b> (${m.role})<br>${m.text}<small>${m.time}</small>`;
      messages.appendChild(d);
    });
    messages.scrollTop=messages.scrollHeight;
  });
}

/* ===== TAB SWITCH ===== */
window.showTab = (id,el)=>{
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
};

/* ===== AUTH STATE ===== */
onAuthStateChanged(auth,user=>{
  if(user){currentUser=user; get(ref(db,'users/'+user.uid)).then(snap=>{
    if(snap.exists()){currentNick=snap.val().nick; currentRole=snap.val().role; showSystem(); }
  });}
});
</script>

<style>
:root{
  --bg:#01020a; --panel:#02040d; --accent:#7aa2ff; --text:#dbe6ff;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Orbitron}
body{background:radial-gradient(circle,#02040d,#01020a);color:var(--text);overflow:hidden}

/* AUTH */
#authScreen,#welcomeScreen,#systemScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;}
.authBox,input,button{width:100%;padding:14px;margin-top:12px;border-radius:12px;}
.authBox{background:rgba(5,8,20,.95);padding:36px;text-align:center;border:1px solid rgba(80,160,255,.25);}
button{background:linear-gradient(135deg,#7aa2ff,#4c6fff);cursor:pointer;color:#fff;font-weight:700;}
button:hover{box-shadow:0 0 25px var(--accent);transform:scale(1.03);}
.logo{font-size:2rem;font-weight:800;color:var(--accent);margin-bottom:12px;text-shadow:0 0 12px #7aa2ff;}

/* WELCOME */
#welcomeScreen{display:none;flex-direction:column;text-align:center;}
#welcomeScreen h1{font-size:2.5rem;margin-bottom:16px;}
#welcomeScreen button{width:220px;margin-top:20px;}

/* SYSTEM */
#systemScreen{display:none;flex-direction:row;width:100%;height:100vh;}
.sidebar{width:260px;padding:24px;background:rgba(5,8,20,.96);border-right:1px solid rgba(80,160,255,.25);}
.content{flex:1;padding:32px;overflow-y:auto;}
.messages{height:300px;overflow-y:auto;background:rgba(0,10,30,.9);border-radius:16px;padding:16px;margin-bottom:12px;}
.message{padding:10px;border-radius:14px;background:rgba(10,20,50,.6);margin-bottom:8px;}
.message.me{background:rgba(60,120,255,.8);color:#02030a;}
.hidden{display:none;}
</style>

<body>

<!-- AUTH -->
<div id="authScreen">
  <div class="authBox">
    <div class="logo">K-NET</div>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="login()">LOGIN</button>
    <hr style="margin:20px 0;border-color:rgba(80,160,255,.25)">
    <input id="regEmail" placeholder="Email">
    <input id="regPass" type="password" placeholder="Password">
    <input id="regNick" placeholder="Nickname">
    <select id="regRole">
      <option value="">Role</option>
      <option>Chauffeur</option>
      <option>Logisticien</option>
      <option>Organisateur</option>
      <option>M√©canicien</option>
      <option>Administrateur</option>
    </select>
    <button onclick="register()">REGISTER</button>
  </div>
</div>

<!-- WELCOME -->
<div id="welcomeScreen">
  <h1>WELCOME TO K-NET</h1>
  <p>You are now part of a closed neural network designed for coordination and secure communication.</p>
  <button onclick="welcomeScreen.style.display='none'; systemScreen.style.display='flex'">ENTER SYSTEM</button>
</div>

<!-- SYSTEM -->
<div id="systemScreen">
  <div class="sidebar">
    <strong>K-NET</strong>
    <div class="menu">
      <button class="active" onclick="showTab('global',this)">üåê Global</button>
      <button onclick="showTab('profile',this)">üë§ Profile</button>
      <button onclick="logout()">üö™ Logout</button>
    </div>
    <select id="roomSelect" style="margin-top:12px;"></select>
  </div>
  <div class="content">
    <section id="global">
      <div class="messages" id="messages"></div>
      <textarea id="chatText" placeholder="Message..."></textarea>
      <button onclick="sendMessage()">Send</button>
    </section>
    <section id="profile" class="hidden">
      <input id="userName" disabled placeholder="Nickname">
      <input id="userRole" disabled placeholder="Role">
    </section>
  </div>
</div>

</body>
</html>
